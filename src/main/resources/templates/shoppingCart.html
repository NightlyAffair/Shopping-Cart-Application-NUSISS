<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>My Cart</title>
</head>
<body>
    <h2>Shopping Cart</h2>

    <table border="1">
        <thead>
        <tr>
            <th></th>
            <th>Product Id</th>
            <th>Product Name</th>
            <th>Description</th>
            <th>Unit Price</th>
            <th>Quantity</th>
            <th>Subtotal</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody>

        <tr th:each="item : ${products}">
            <td>
                <input type="checkbox" class="select-product" name="selectedProducts"
                       th:value="${item.product.productId}">
            </td>
            <td th:text="${item.productId}"></td>
            <td th:text="${item.product.productName}"></td>
            <td th:text="${item.product.description}"></td>
            <td th:text="${item.product.unitPrice}"></td>
            <td th:text="${item.quantity}"></td>
            <td th:text="${item.subPrice}"></td>

            <td><span class="subtotal" th:text="${item.subPrice}"></span></td>
            <td>
                <form th:action="@{/shoppingCartDetail/plus}" method="post" style="display:inline;">
                    <input type="hidden" name="customerId" th:value="${customerId}">
                    <input type="hidden" name="productId" th:value="${item.productId}">
                    <button type="submit">+</button>
                </form>


                <form th:action="@{/shoppingCartDetail/minus}" method="post" style="display:inline;">
                    <input type="hidden" name="customerId" th:value="${customerId}">
                    <input type="hidden" name="productId" th:value="${item.productId}">
                    <button type="submit">-</button>
                </form>


                <form th:action="@{/shoppingCartDetail/remove}" method="post" style="display:inline;">
                    <input type="hidden" name="customerId" th:value="${customerId}">
                    <input type="hidden" name="productId" th:value="${item.productId}">
                    <button type="submit">Remove</button>
                </form>
            </td>
        </tr>
        </tbody>
    </table>


    <h3>Total in Cart: <span th:text="${totalPrice}"></span></h3>
    <div id="selectedList"></div>
    <h3>Selected Total: <span id="selectedTotal">0.0</span></h3>

    <form th:action="@{/shoppingCartDetail/clear}" method="post">
        <input type="hidden" name="customerId" th:value="${customerId}">
        <button type="submit">Clear Cart</button>
    </form>

    <!-- 去结算 -->
    <form th:action="@{/shoppingCartDetail/checkout}" method="post">
        <input type="hidden" name="customerId" th:value="${customerId}">
        <button type="submit">Checkout</button>
    </form>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const checkboxes = document.querySelectorAll(".select-product");
            const totalSpan = document.getElementById("selectedTotal");
            const listDiv = document.getElementById("selectedList");

            function updateTotal() {
                let sum = 0;
                let details = "";
                checkboxes.forEach((cb) => {
                    if (cb.checked) {
                        let row = cb.closest("tr");
                        let name = row.querySelector(".pname").textContent;
                        let qty = row.querySelector(".qty").textContent;
                        let subtotal = row.querySelector(".subtotal").textContent;
                        details += `<div>${name} × ${qty} = ${subtotal}</div>`;
                        sum += parseFloat(subtotal);
                    }
                });
                listDiv.innerHTML = details || "<div>No products selected</div>";
                totalSpan.textContent = sum.toFixed(2);
            }

            checkboxes.forEach(cb => cb.addEventListener("change", updateTotal));
        });
    </script>
</body>
</html>