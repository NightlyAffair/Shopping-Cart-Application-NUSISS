<!--
* displayProduct HTML
* Authors: Glenn Min, Sheng Qi, Nithvin, YongHui
* Date: 2025-10-05
* Last Modified by: YongHui
* New Updates: JS changes.
* Last Modified: 2025-10-15
-->

<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <title>Browse Products</title>

    <!-- Bootstrap CSS + Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

    <!-- Global Styles -->
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" th:href="@{/css/displayProducts.css}">
</head>
<body>

<!-- Header -->
<header class="site-header">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-3">
                <div class="logo">
                    <h5>Shop @ISS</h5>
                </div>
            </div>
            <div class="col-md-6 text-center d-none d-md-block">
                <span class="promotional-text">Today's Deals: Free shipping over $80 | 10% off on new arrivals</span>
            </div>
            <div class="col-md-3 d-flex justify-content-end">
                <!-- If Not Logged -->
                <div th:if="${session.login_status == null || session.login_status == false}">
                    <div class="user-actions d-flex align-items-center justify-content-end gap-2">
                        <a th:href="@{/login}" class="btn btn-outline-light btn-sm">Login</a>
                        <a href="http://localhost:3000/#/signup" class="btn btn-warning btn-sm">Sign Up</a>
                    </div>
                </div>
                    <!-- Logged In -->
                    <div th:if="${session.login_status != null && session.login_status == true}">
                        <div class="dropdown user-dropdown">
                            <a href="#"
                               class="d-flex align-items-center gap-2 text-decoration-none dropdown-toggle"
                               data-bs-toggle="dropdown"
                               aria-expanded="false">
                                <img src="https://images.unsplash.com/photo-1750535135593-3a8e5def331d?ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&q=80&w=1480"
                                     alt="user profile"
                                     width="40"
                                     height="40"
                                     class="rounded-circle" />
                                <i class="bi bi-chevron-down text-white"></i>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="http://localhost:3000/#/accountInfo">
                                    <i class="bi bi-gear me-2"></i>Settings
                                </a></li>
                                <li><a class="dropdown-item" href="http://localhost:3000/#/purchaseHistory">
                                    <i class="bi bi-clock-history me-2"></i>View Purchase History
                                </a></li>
                                <li><hr class="dropdown-divider" /></li>
                                <li><a class="dropdown-item" th:href="@{/login/logout}">
                                    <i class="bi bi-box-arrow-right me-2"></i>Sign out
                                </a></li>
                            </ul>
                        </div>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- NavBar -->
<nav class="navbar navbar-expand-lg navbar-dark site-navbar">
    <div class="container">
        <a class="navbar-brand" th:href="@{/products}">
            <i class="bi bi-grid-3x3-gap me-2"></i>Browse
        </a>
        <button class="navbar-toggler" data-bs-target="#navbarNav" data-bs-toggle="collapse" type="button">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item">
                    <a class="nav-link" th:href="@{/favourites}">
                        <i class="bi bi-heart-fill me-1"></i>Favourites
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" th:href="@{/products/cart/view}">
                        <i class="bi bi-cart3 me-1"></i>Cart
                    </a>
                </li>
            </ul>
        </div>
    </div>
</nav>

<!-- Filter -->
<section class="filter-bar">
    <div class="container">
        <form method="get" th:action="@{/products/page}">
            <div class="row g-3 align-items-center">
                <div class="col-md-4">
                    <input class="form-control" name="keyword" placeholder="Search products..."
                           th:value="${currentKeyword}" type="text">
                </div>
                <div class="col-md-2">
                    <select class="form-select" name="categoryId">
                        <option value="0">All Categories</option>
                        <option th:each="category : ${categories}"
                                th:selected="${category.categoryId == selectedCategory}"
                                th:text="${category.name}"
                                th:value="${category.categoryId}">
                        </option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select" name="sort">
                        <option th:selected="${currentSort == 'nameAsc'}" value="nameAsc">Name A-Z</option>
                        <option th:selected="${currentSort == 'nameDesc'}" value="nameDesc">Name Z-A</option>
                        <option th:selected="${currentSort == 'priceAsc'}" value="priceAsc">Price: Low → High</option>
                        <option th:selected="${currentSort == 'priceDesc'}" value="priceDesc">Price: High → Low</option>
                        <option th:selected="${currentSort == 'rating'}" value="rating">Top Rated</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-primary w-100" type="submit">
                        <i class="bi bi-search me-1"></i>Search
                    </button>
                </div>
                <div class="col-md-2 text-end">
                    <span class="text-muted" th:text="${totalItems} + ' products'">0 products</span>
                </div>
            </div>
        </form>
    </div>
</section>

<!-- Main Section -->
<main class="container my-5">
    <div class="row row-cols-2 row-cols-md-3 row-cols-lg-4 row-cols-xl-5 g-4">
        <div class="col" th:each="product : ${products}">
            <div class="card h-100 position-relative product-card">

                <!-- Favorite Button -->
                <button class="wishlist-btn fav-btn" th:attr="data-id=${product.productId}"
                        title="Add to Favorites"
                        type="button">
                    <i class="bi bi-heart"></i>
                </button>

                <a class="text-decoration-none" th:href="@{/products/details/{id}(id=${product.productId})}">
                    <img alt="Product Image" class="card-img-top" th:src="${product.imageUrl}">
                </a>

                <div class="card-body">
                    <h6 class="card-title">
                        <a class="text-decoration-none text-dark"
                           th:href="@{/products/details/{id}(id=${product.productId})}"
                           th:text="${product.productName}">Product Name</a>
                    </h6>
                    <p class="card-text text-muted" th:text="${product.description}">Description</p>
                    <p class="fw-bold text-primary">
                        $<span th:text="${#numbers.formatDecimal(product.unitPrice, 1, 2)}">0.00</span>
                    </p>

                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-warning">
                            <i class="bi bi-star-fill"></i>
                            <span th:text="${product.averageRating != null ? #numbers.formatDecimal(product.averageRating, 1, 1) : '0.0'}">0.0</span>
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- No products found -->
        <div class="col-12 text-center" th:if="${#lists.isEmpty(products)}">
            <p class="text-muted">No products found. Try adjusting your filters.</p>
        </div>
    </div>

    <!-- Pagination -->
    <nav aria-label="Product pagination" class="mt-5" th:if="${totalPages > 1}">
        <ul class="pagination justify-content-center">
            <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                <a class="page-link"
                   th:href="@{/products/page(pageNumber=${currentPage - 1}, categoryId=${selectedCategory}, keyword=${currentKeyword}, sort=${currentSort})}">
                    Previous
                </a>
            </li>

            <li class="page-item"
                th:classappend="${pageNum == currentPage} ? 'active'"
                th:each="pageNum : ${#numbers.sequence(0, totalPages - 1)}">
                <a class="page-link"
                   th:href="@{/products/page(pageNumber=${pageNum}, categoryId=${selectedCategory}, keyword=${currentKeyword}, sort=${currentSort})}"
                   th:text="${pageNum + 1}">1</a>
            </li>

            <li class="page-item" th:classappend="${currentPage + 1 >= totalPages} ? 'disabled'">
                <a class="page-link"
                   th:href="@{/products/page(pageNumber=${currentPage + 1}, categoryId=${selectedCategory}, keyword=${currentKeyword}, sort=${currentSort})}">
                    Next
                </a>
            </li>
        </ul>
    </nav>
</main>

<!-- Footer -->
<footer class="site-footer">
    <div class="container text-center">
        <p>&copy; 2025 TEAM_TWO. All rights reserved.</p>
    </div>
</footer>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.fav-btn').forEach(btn => {
            const productId = btn.getAttribute('data-id');
            const icon = btn.querySelector('i');

            fetch(`/favourites/status/${productId}`)
                .then(response => {
                    if (!response.ok) throw new Error('Network response not ok');
                    return response.json();
                })
                .then(isFavourited => {
                    if (isFavourited) {
                        icon.classList.add('bi-heart-fill', 'text-danger');
                        icon.classList.remove('bi-heart');
                    } else {
                        icon.classList.add('bi-heart');
                        icon.classList.remove('bi-heart-fill', 'text-danger');
                    }
                })
                .catch(error => console.error('Fav status check failed', error));

            btn.addEventListener('click', async function (event) {
                event.preventDefault();
                console.log('Clicked fav button', productId);

                try {
                    const response = await fetch(`/favourites/save`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: `productId=${encodeURIComponent(productId)}`
                    });

                    if (!response.ok) throw new Error('Toggle failed');

                    const result = await response.text();
                    if (result.trim().toLowerCase().includes('added')) {
                        // On added, show filled heart
                        icon.classList.remove('bi-heart');
                        icon.classList.add('bi-heart-fill', 'text-danger');
                    } else if (result.trim().toLowerCase().includes('removed')) {
                        // On removed, show empty heart
                        icon.classList.remove('bi-heart-fill', 'text-danger');
                        icon.classList.add('bi-heart');
                    }
                } catch (err) {
                    console.error('Fav button toggle failed:', err);
                }
            });
        });
    });
</script>
</body>
</html>